<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Inventario TCG</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Placeholder Comments -->
    <!-- Chosen Palette: Warm Neutrals with Subtle Blue Accents -->
    <!-- Application Structure Plan: A single-page dashboard layout. Top section for KPIs (total value, item count). Main area with a filter panel (by brand, collection, type) and a dynamic, sortable inventory table. A bottom section with charts (pie chart for brand distribution, bar chart for value by collection). This structure provides an immediate overview, allows for detailed exploration via filtering/sorting, and offers visual synthesis through charts, which is more intuitive than a raw spreadsheet. -->
    <!-- Visualization & Content Choices: Data from the report is stored in a JS array. KPIs (Inform): HTML cards updated by JS. Inventory Table (Organize/Compare): Dynamic HTML table with JS sorting/filtering. Distribution Chart (Compare): Chart.js Pie Chart showing stock value by brand. Value Chart (Compare): Chart.js Bar Chart showing stock value by top collections. All interactions are handled by vanilla JS to update the views. This meets the goal of making data explorable and understandable. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Color de fondo claro y neutro */
            color: #1a202c; /* Color de texto oscuro por defecto */
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark {
            background-color: #1a202c; /* Color de fondo oscuro */
            color: #e2e8f0; /* Color de texto claro */
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        body.dark .kpi-card {
            background-color: #2d3748;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
            max-height: 400px;
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: background-color 0.3s;
        }
        body.dark .chart-container {
            background-color: #2d3748;
        }
        /* Estilo para la cabecera de la tabla fija */
        .table-header-sticky {
            position: sticky;
            top: 0;
            background-color: #f1f5f9;
            z-index: 10;
            transition: background-color 0.3s;
        }
        body.dark .table-header-sticky {
            background-color: #4a5568;
        }
        /* Estilo para el icono de ordenación */
        .sort-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .sort-icon.active {
            opacity: 1;
        }
        .sort-icon:hover {
            opacity: 1;
        }
        .form-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-top: 2rem;
            transition: background-color 0.3s;
        }
        body.dark .form-section {
            background-color: #2d3748;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .quantity-button {
            background-color: #e2e8f0;
            color: #4a5568;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, color 0.3s;
        }
        .quantity-button:hover {
            background-color: #cbd5e0;
        }
        body.dark .quantity-button {
            background-color: #616e7f;
            color: #e2e8f0;
        }
        body.dark .quantity-button:hover {
            background-color: #718096;
        }
        .quantity-display {
            min-width: 2rem;
            text-align: center;
        }

        /* Estilos para el modal de confirmación */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transition: background-color 0.3s;
        }
        body.dark .modal-content {
            background-color: #2d3748;
        }
        /* Ensure modal text is white in dark mode */
        body.dark .modal-content p {
            color: #e2e8f0; /* Light text for dark mode */
        }
        .modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.3s;
        }
        .modal-button.confirm {
            background-color: #ef4444;
            color: white;
            border: 1px solid #ef4444;
        }
        .modal-button.confirm:hover {
            background-color: #dc2626;
            border-color: #dc2626;
        }
        .modal-button.cancel {
            background-color: #e2e8f0;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        .modal-button.cancel:hover {
            background-color: #cbd5e0;
            border-color: #cbd5e0;
        }
        body.dark .modal-button.cancel {
            background-color: #616e7f;
            color: #e2e8f0;
            border-color: #616e7f;
        }
        body.dark .modal-button.cancel:hover {
            background-color: #718096;
            border-color: #718096;
        }

        /* Estilos para el indicador de carga */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Mayor que el modal */
        }
        body.dark .loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilo para bajo stock */
        .low-stock {
            background-color: #fffbeb; /* Amarillo claro */
        }
        body.dark .low-stock {
            background-color: #5a4b00; /* Amarillo oscuro */
        }
        .zero-stock {
            background-color: #fee2e2; /* Rojo claro */
        }
        body.dark .zero-stock {
            background-color: #6b0000; /* Rojo oscuro */
        }

        /* Estilos para mensajes de error del formulario */
        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* Estilos para inputs y selects */
        .form-input {
            background-color: white;
            color: #1a202c;
            border-color: #cbd5e0;
        }
        body.dark .form-input {
            background-color: #4a5568; /* Darker background for inputs */
            color: #e2e8f0; /* Light text for inputs */
            border-color: #616e7f; /* Lighter border for inputs */
        }
        body.dark select.form-input {
            /* Custom arrow for dark mode selects to be visible */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e2e8f0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8rem 0.8rem;
            /* Ensure text color is light for options in dark mode */
            color: #e2e8f0;
            -webkit-appearance: none; /* Remove default arrow on WebKit browsers */
            -moz-appearance: none;    /* Remove default arrow on Firefox */
            appearance: none;         /* Remove default arrow */
        }
        body.dark option {
            background-color: #2d3748; /* Dark background for options in dark mode */
            color: #e2e8f0; /* Light text color for options in dark mode */
        }
        
        /* Text colors for dark mode */
        body.dark .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark .text-gray-900 {
            color: #e2e8f0;
        }
        body.dark .text-gray-600 {
            color: #a0aec0;
        }
        body.dark .text-gray-500 {
            color: #a0aec0;
        }
        body.dark .divide-gray-200 {
            border-color: #4a5568;
        }
        body.dark .divide-gray-200 > tr > td, body.dark .divide-gray-200 > tr > th {
            border-color: #4a5568;
        }
        body.dark .bg-white {
            background-color: #2d3748;
        }
        body.dark .bg-gray-100 {
            background-color: #4a5568;
        }
        body.dark .border-gray-300 {
            border-color: #616e7f;
        }
        body.dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        }
        body.dark .hover\:bg-gray-50:hover {
            background-color: #4a5568;
        }
        body.dark .text-green-700 {
            color: #4ade80; /* Brighter green for dark mode */
        }
        body.dark .text-red-600 {
            color: #f87171; /* Brighter red for dark mode */
        }
        body.dark .hover\:text-red-900:hover {
            color: #ef4444; /* Darker red on hover for dark mode */
        }

    </style>
</head>
<body class="text-gray-800">

    <!-- Modal de Confirmación (oculto por defecto) -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modal-message" class="text-lg font-semibold text-gray-800">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="modal-buttons">
                <button id="confirm-button" class="modal-button confirm">Confirmar</button>
                <button id="cancel-button" class="modal-button cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Indicador de Carga (oculto por defecto) -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Encabezado -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start relative">
            <div class="flex flex-col md:flex-row items-center mb-4 md:mb-0 w-full md:w-auto">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mr-4 mb-2 md:mb-0">Panel de Control de Inventario TCG</h1>
            </div>
            
            <div class="flex flex-col md:flex-row items-end md:items-center space-y-4 md:space-y-0 md:space-x-6 mt-4 md:mt-0">
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-700 flex items-center">
                        Dólar Blue: 
                        <input type="number" id="dolar-blue-input" value="1000" step="0.01" class="ml-2 w-24 px-2 py-1 border border-gray-300 rounded-md text-center bg-white form-input" oninput="renderAll()"> ARS
                    </div>
                    <div class="text-sm text-gray-700 flex items-center">
                        Comisión Envío: 
                        <input type="number" id="shipping-commission-input" value="20" min="0" max="100" step="0.01" class="ml-2 w-20 px-2 py-1 border border-gray-300 rounded-md text-center bg-white form-input" oninput="renderAll()"> %
                    </div>
                </div>
                <!-- Dark Mode Toggle - Positioned for better layout -->
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 text-gray-800 shadow-md transition-colors duration-300">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Sección de KPIs (Indicadores Clave de Rendimiento) -->
        <section id="kpi-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Las tarjetas de KPIs se generarán aquí con JS -->
        </section>

        <!-- Sección de Filtros y Tabla -->
        <main class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Inventario/Stock Disponible</h2>
            <!-- Controles de Filtro -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-end">
                <div>
                    <label for="brand-filter" class="block text-sm font-medium text-gray-700">Filtrar por Marca</label>
                    <select id="brand-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                        <!-- Opciones generadas por JS -->
                    </select>
                </div>
                <div>
                    <label for="collection-filter" class="block text-sm font-medium text-gray-700">Filtrar por Colección</label>
                    <select id="collection-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                        <!-- Opciones generadas por JS -->
                    </select>
                </div>
                <div>
                    <label for="expansion-filter" class="block text-sm font-medium text-gray-700">Filtrar por Expansión</label>
                    <select id="expansion-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                        <!-- Opciones generadas por JS -->
                    </select>
                </div>
                <div>
                    <label for="item-filter" class="block text-sm font-medium text-gray-700">Filtrar por Artículo</label>
                    <select id="item-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                        <!-- Opciones generadas por JS -->
                    </select>
                </div>
                <div>
                    <label for="search-input" class="block text-sm font-medium text-gray-700">Buscar por Comentarios</label>
                    <input type="text" id="search-input" placeholder="Ej: Shiny Mewtwo..." class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                </div>
            </div>
            
            <!-- Botón de Exportar -->
            <div class="flex justify-end mb-4">
                <button id="export-csv-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300">
                    Exportar a CSV
                </button>
            </div>

            <!-- Contenedor de la Tabla de Inventario -->
            <div class="overflow-x-auto max-h-[60vh] relative">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header-sticky">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Imagen</th> <!-- New column for Image -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="marca">Marca</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="coleccion">Colección</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="expansion">Expansión</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="articulo">Artículo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Comentarios</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="cantidad">Stock</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="costo">Costo (USD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="venta">Venta (USD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="ventaArs">Venta (ARS)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort="margenGanancia">Margen de Ganancia (USD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas generadas por JS -->
                    </tbody>
                </table>
                 <div id="no-results" class="text-center py-10 text-gray-500 hidden">
                    No se encontraron resultados para los filtros aplicados.
                </div>
            </div>

        </main>
        
        <!-- Sección para Agregar Stock -->
        <section class="form-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Agregar Nuevo Stock</h2>
            <form id="add-stock-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="new-marca" class="block text-sm font-medium text-gray-700">Marca</label>
                    <select id="new-marca" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                        <!-- Opciones generadas por JS -->
                    </select>
                    <p id="error-new-marca" class="error-message hidden">La marca es obligatoria.</p>
                </div>
                <div>
                    <label for="new-coleccion" class="block text-sm font-medium text-gray-700">Colección</label>
                    <select id="new-coleccion" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                        <!-- Opciones generadas por JS -->
                    </select>
                    <p id="error-new-coleccion" class="error-message hidden">La colección es obligatoria.</p>
                </div>
                <div>
                    <label for="new-expansion" class="block text-sm font-medium text-gray-700">Expansión</label>
                    <input type="text" id="new-expansion" list="expansions-datalist" placeholder="Ej: Paldean Fates" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <datalist id="expansions-datalist">
                        <!-- Options populated by JS -->
                    </datalist>
                    <p id="error-new-expansion" class="error-message hidden">La expansión es obligatoria.</p>
                </div>
                <div>
                    <label for="new-articulo" class="block text-sm font-medium text-gray-700">Artículo</label>
                    <select id="new-articulo" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                        <!-- Opciones generadas por JS -->
                    </select>
                    <p id="error-new-articulo" class="error-message hidden">El artículo es obligatorio.</p>
                </div>
                <div>
                    <label for="new-comentarios" class="block text-sm font-medium text-gray-700">Comentarios</label>
                    <input type="text" id="new-comentarios" placeholder="Ej: Shiny Mewtwo" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                </div>
                <div>
                    <label for="new-idioma" class="block text-sm font-medium text-gray-700">Idioma</label>
                    <select id="new-idioma" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                        <!-- Opciones generadas por JS -->
                    </select>
                    <p id="error-new-idioma" class="error-message hidden">El idioma es obligatorio.</p>
                </div>
                <div>
                    <label for="new-cantidad" class="block text-sm font-medium text-gray-700">Cantidad en Stock</label>
                    <input type="number" id="new-cantidad" min="0" placeholder="Ej: 10" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <p id="error-new-cantidad" class="error-message hidden">La cantidad debe ser un número válido.</p>
                </div>
                <div>
                    <label for="new-costo" class="block text-sm font-medium text-gray-700">Costo Unitario (USD)</label>
                    <input type="number" id="new-costo" step="0.01" min="0" placeholder="Ej: 45.50" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <p id="error-new-costo" class="error-message hidden">El costo unitario debe ser un número válido.</p>
                </div>
                <div>
                    <label for="new-venta" class="block text-sm font-medium text-gray-700">Precio Venta (USD)</label>
                    <input type="number" id="new-venta" step="0.01" min="0" placeholder="Ej: 65.00" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <p id="error-new-venta" class="error-message hidden">El precio de venta debe ser un número válido.</p>
                </div>
                <div>
                    <label for="new-venta-ars" class="block text-sm font-medium text-gray-700">Precio Venta (ARS)</label>
                    <input type="number" id="new-venta-ars" step="0.01" min="0" class="mt-1 block w-full pl-3 py-2 text-base bg-gray-100 border-gray-300 rounded-md form-input" readonly>
                </div>
                <div>
                    <label for="new-margen-ganancia" class="block text-sm font-medium text-gray-700">Margen de Ganancia (USD)</label>
                    <input type="number" id="new-margen-ganancia" step="0.01" min="0" class="mt-1 block w-full pl-3 py-2 text-base bg-gray-100 border-gray-300 rounded-md form-input" readonly>
                </div>
                <div>
                    <label for="new-estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="new-estado" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                        <!-- Opciones generadas por JS -->
                    </select>
                    <p class="text-xs text-gray-500 mt-1">El Costo Neto está calculado como el Costo Unitario más la comisión de envío.</p>
                    <p id="error-new-estado" class="error-message hidden">El estado es obligatorio.</p>
                </div>
                <div>
                    <label for="new-image-file" class="block text-sm font-medium text-gray-700">Subir Imagen del Producto</label>
                    <input type="file" id="new-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100"/>
                    <p class="text-xs text-gray-500 mt-1">Selecciona un archivo de imagen (JPG, PNG, GIF). Se guardará en Firebase Storage.</p>
                </div>
                <div class="lg:col-span-3 flex justify-end mt-4">
                    <button type="submit" id="submit-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                        Agregar Stock
                    </button>
                </div>
            </form>
            <div id="form-message" class="mt-4 text-center text-sm font-medium hidden"></div>
        </section>

        <!-- Sección para Registrar Ventas -->
        <section class="form-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Registrar Venta</h2>
            <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:col-span-3 gap-4">
                <div>
                    <label for="sale-item-select" class="block text-sm font-medium text-gray-700">Artículo Vendido</label>
                    <select id="sale-item-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                        <option value="">Selecciona un artículo</option>
                        <!-- Opciones generadas por JS -->
                    </select>
                    <p id="error-sale-item-select" class="error-message hidden">Selecciona un artículo.</p>
                </div>
                <div>
                    <label for="sale-quantity-input" class="block text-sm font-medium text-gray-700">Cantidad Vendida</label>
                    <input type="number" id="sale-quantity-input" min="1" placeholder="Ej: 1" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <p id="error-sale-quantity-input" class="error-message hidden">Cantidad vendida inválida.</p>
                </div>
                <div>
                    <label for="sale-price-per-unit-input" class="block text-sm font-medium text-gray-700">Precio de Venta por Unidad (USD)</label>
                    <input type="number" id="sale-price-per-unit-input" step="0.01" min="0" placeholder="Auto-relleno" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <p id="error-sale-price-per-unit-input" class="error-message hidden">Precio de venta inválido.</p>
                </div>
                <div>
                    <label for="sale-date-input" class="block text-sm font-medium text-gray-700">Fecha de Venta</label>
                    <input type="date" id="sale-date-input" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input" required>
                    <p id="error-sale-date-input" class="error-message hidden">La fecha es obligatoria.</p>
                </div>
                <div>
                    <label for="sale-comments-input" class="block text-sm font-medium text-gray-700">Comentarios de la Venta</label>
                    <input type="text" id="sale-comments-input" placeholder="Ej: Cliente Juan Pérez" class="mt-1 block w-full pl-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md form-input">
                </div>
                <div class="lg:col-span-3 flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-300">
                        Registrar Venta
                    </button>
                </div>
            </form>
            <div id="sale-form-message" class="mt-4 text-center text-sm font-medium hidden"></div>
        </section>

        <!-- Sección de KPIs de Ventas -->
        <section id="sales-kpi-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 mb-8">
            <!-- Las tarjetas de KPIs de ventas se generarán aquí con JS -->
        </section>

        <!-- Sección de Últimas Ventas Registradas -->
        <section class="bg-white p-6 rounded-xl shadow-lg mt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Últimas Ventas Registradas</h2>
            <div class="overflow-x-auto max-h-[40vh] relative">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header-sticky">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Artículo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Cantidad</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Precio Unitario (USD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Total Venta (USD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Ganancia (USD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Comentarios</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Acciones</th> <!-- New: Actions column for sales -->
                        </tr>
                    </thead>
                    <tbody id="sales-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de ventas generadas por JS -->
                    </tbody>
                </table>
                <div id="no-sales-results" class="text-center py-10 text-gray-500 hidden">
                    No se encontraron ventas registradas.
                </div>
            </div>
        </section>

        <!-- Sección de Gráficos (Eliminada) -->
        <!-- <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4 text-center">Valor de Stock por Marca</h3>
                <canvas id="brandChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4 text-center">Top 5 Colecciones por Valor de Stock</h3>
                <canvas id="collectionChart"></canvas>
            </div>
        </section> -->
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js"; // Import for Storage

        // --- GLOBAL APP ID ---
        // Para recuperar tus datos, por favor, verifica en tu consola de Firebase (Firestore Database)
        // cuál de las colecciones bajo 'artifacts/' contiene tus datos actualizados.
        // Reemplaza 'TU_ID_DE_APP_AQUI' con el ID exacto de esa colección.
        // Por ejemplo, si tus datos están en 'artifacts/mi-inventario-tcg-colaborativo/public/data/sharedInventory',
        // entonces TU_ID_DE_APP_AQUI sería 'mi-inventario-tcg-colaborativo'.
        // Basado en tu captura, podría ser 'c_cbeb5ae8e18f9dd4_tcg_stock_dashboard_firebase_shared-7'
        // o 'mi-inventario-tcg-colaborativo'.
        const appId = 'c_cbeb5ae8e18f9dd4_tcg_stock_dashboard_firebase_shared-7'; // <-- ¡IMPORTANTE: Reemplaza esto con tu ID correcto!
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'c_cbeb5ae8e18f9dd4_tcg_stock_dashboard_firebase_shared-833'; // Línea original comentada

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBrdeZI_MmSGJN78c7QrLNoq2JehAuxdZo",
          authDomain: "tcg-import-ar.firebaseapp.com",
          projectId: "tcg-import-ar",
          storageBucket: "tcg-import-ar.appspot.com", // Asegúrate de que este sea el bucket correcto
          messagingSenderId: "301376070433",
          appId: "1:301376070433:web:dc11b17cbfce23f5d4d460",
          measurementId: "G-2YT0YYQJ56"
        };

        // Declarar las variables app, db, auth globalmente
        let app;
        let db;
        let auth;
        let storage; // Declare storage globally

        let userId = null;
        let isAuthReady = false; // Flag to indicate if authentication is ready

        // --- GLOBAL STATE & ELEMENTS ---
        let inventoryData = []; // This will now be populated by Firestore
        let salesData = []; // New: To store sales records
        let currentSort = { column: 'marca', order: 'asc' };
        const kpiSection = document.getElementById('kpi-section');
        const salesKpiSection = document.getElementById('sales-kpi-section'); // New: Sales KPI section
        const tableBody = document.getElementById('inventory-table-body');
        const salesTableBody = document.getElementById('sales-table-body'); // New: Sales table body
        const brandFilter = document.getElementById('brand-filter');
        const collectionFilter = document.getElementById('collection-filter');
        const expansionFilter = document.getElementById('expansion-filter');
        const itemFilter = document.getElementById('item-filter');
        const searchInput = document.getElementById('search-input');
        const noResultsDiv = document.getElementById('no-results');
        const noSalesResultsDiv = document.getElementById('no-sales-results'); // New: No sales results div

        // Modal de confirmación
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const confirmButton = document.getElementById('confirm-button');
        const cancelButton = document.getElementById('cancel-button');
        let onConfirmCallback = null; // Callback para la acción a confirmar

        // Indicador de carga
        const loadingOverlay = document.getElementById('loading-overlay');

        // New stock form elements
        const addStockForm = document.getElementById('add-stock-form');
        const newMarcaSelect = document.getElementById('new-marca');
        const newColeccionSelect = document.getElementById('new-coleccion');
        const newExpansionInput = document.getElementById('new-expansion');
        const newArticuloSelect = document.getElementById('new-articulo');
        const newComentariosInput = document.getElementById('new-comentarios');
        const newIdiomaSelect = document.getElementById('new-idioma');
        const newCantidadInput = document.getElementById('new-cantidad');
        const newCostoInput = document.getElementById('new-costo');
        const newVentaInput = document.getElementById('new-venta');
        const newVentaArsInput = document.getElementById('new-venta-ars');
        const newMargenGananciaInput = document.getElementById('new-margen-ganancia');
        const newEstadoSelect = document.getElementById('new-estado');
        const newImageFileInput = document.getElementById('new-image-file'); // Changed to file input
        const submitButton = document.querySelector('#add-stock-form button[type="submit"]'); // Reference to the submit button
        const formMessage = document.getElementById('form-message');
        const dolarBlueInput = document.getElementById('dolar-blue-input');
        const shippingCommissionInput = document.getElementById('shipping-commission-input'); // New shipping commission input
        const expansionsDatalist = document.getElementById('expansions-datalist');

        // Error message elements for Add Stock form
        const errorNewMarca = document.getElementById('error-new-marca');
        const errorNewColeccion = document.getElementById('error-new-coleccion');
        const errorNewExpansion = document.getElementById('error-new-expansion');
        const errorNewArticulo = document.getElementById('error-new-articulo');
        const errorNewIdioma = document.getElementById('error-new-idioma');
        const errorNewCantidad = document.getElementById('error-new-cantidad');
        const errorNewCosto = document.getElementById('error-new-costo');
        const errorNewVenta = document.getElementById('error-new-venta');
        // Corrected ID lookup for errorNewEstado
        const errorNewEstado = document.getElementById('error-new-estado'); 

        // New sales form elements
        const addSaleForm = document.getElementById('add-sale-form');
        const saleItemSelect = document.getElementById('sale-item-select');
        const saleQuantityInput = document.getElementById('sale-quantity-input');
        const salePricePerUnitInput = document.getElementById('sale-price-per-unit-input');
        const saleDateInput = document.getElementById('sale-date-input');
        const saleCommentsInput = document.getElementById('sale-comments-input');
        const saleFormMessage = document.getElementById('sale-form-message'); // Message for sales form

        // Error message elements for Add Sale form
        const errorSaleItemSelect = document.getElementById('error-sale-item-select');
        const errorSaleQuantityInput = document.getElementById('error-sale-quantity-input');
        const errorSalePricePerUnitInput = document.getElementById('error-sale-price-per-unit-input');
        const errorSaleDateInput = document.getElementById('error-sale-date-input');

        // Export button
        const exportCsvButton = document.getElementById('export-csv-button');

        // Dark mode toggle button
        const themeToggle = document.getElementById('theme-toggle');

        // Chart instances (removed from HTML, but kept variables for safety if re-added)
        let brandChart, collectionChart;

        // --- ARTICLE MAPPINGS FOR NEW STOCK FORM ---
        const articleMappings = {
            'Pokémon TCG': ['Booster Box', 'Elite Trainer Box', 'Booster Bundle', 'Collection Box', 'Mini Tin', 'Blister Pack', 'Single Pack', 'Promo Pack', 'Deck Box'],
            'Magic: The Gathering': ['Booster Box', 'Bundle', 'Commander Deck', 'Pre-release Pack', 'Single Pack', 'Gift Set', 'Fat Pack', 'Set Booster Box', 'Draft Booster Box', 'Collector Booster Box', 'Jumpstart Booster Box', 'Theme Booster'],
            'One Piece Card Game': ['Booster Box', 'Starter Deck', 'Single Pack', 'Gift Set', 'Display Box', 'Tournament Pack'],
            'Disney Lorcana': ['Booster Box', 'Starter Deck', 'Gift Set', 'Booster Pack', 'Illumineer\'s Trove', 'Playmat'],
            'Accesorios': ['Sleeves', 'Toploaders', 'Binders/Portfolios', 'Playmat', 'Deck Box', 'Penny Sleeves', 'Storage Boxes', 'Dice', 'Counters', 'Booster Protectors']
        };

        // --- COLLECTION MAPPINGS (Broader Categories) ---
        const collectionMappings = {
            'Pokémon TCG': [
                'Scarlet & Violet Series', 'Sword & Shield Series', 'Sun & Moon Series', 'XY Series',
                'Black & White Series', 'Diamond & Pearl Series', 'EX Series', 'Base Set Era', 'Promotional Cards'
            ].sort(),
            'Magic: The Gathering': [
                'Standard Sets', 'Modern Sets', 'Commander Products', 'Masters Sets', 'Supplemental Sets', 'Horizons Sets', 'Universes Beyond'
            ].sort(),
            'One Piece Card Game': [
                'Main Sets', 'Starter Decks', 'Promotional Cards'
            ].sort(),
            'Disney Lorcana': [
                'Chapter Sets', 'Gift Sets', 'Promotional Cards'
            ].sort(),
            'Accesorios': [
                'General'
            ].sort()
        };

        // --- EXPANSION MAPPINGS (Specific Expansions per Broad Collection) ---
        const expansionMappings = {
            'Scarlet & Violet Series': [
                'Scarlet & Violet Base', 'Paldea Evolved', 'Obsidian Flames', '151', 'Paradox Rift',
                'Paldean Fates', 'Temporal Forces', 'Twilight Masquerade', 'Prismatic Evolutions',
                'Journey Together', 'Destined Rivals', 'Black Bolt', 'White Flare', 'Mega Evolution',
                'Shrouded Fable', 'Night Wanderer', 'Crimson Haze'
            ].sort(),
            'Sword & Shield Series': [
                'Sword & Shield Base', 'Rebel Clash', 'Darkness Ablaze', 'Vivid Voltage', 'Battle Styles', 'Chilling Reign',
                'Evolving Skies', 'Fusion Strike', 'Brilliant Stars', 'Astral Radiance', 'Pokémon GO', 'Lost Origin',
                'Silver Tempest', 'Crown Zenith', 'Shining Fates', 'Champion\'s Path'
            ].sort(),
            'Sun & Moon Series': [
                'Sun & Moon Base', 'Guardians Rising', 'Burning Shadows', 'Crimson Invasion', 'Ultra Prism', 'Forbidden Light',
                'Celestial Storm', 'Dragon Majesty', 'Lost Thunder', 'Team Up', 'Detective Pikachu', 'Unbroken Bonds',
                'Unified Minds', 'Cosmic Eclipse'
            ].sort(),
            'XY Series': [
                'XY Base', 'Flashfire', 'Furious Fists', 'Phantom Forces', 'Primal Clash', 'Roaring Skies',
                'Ancient Origins', 'BREAKthrough', 'BREAKpoint', 'Generations', 'XY Evolutions'
            ].sort(),
            'Black & White Series': [
                'Black & White Base', 'Emerging Powers', 'Noble Victories', 'Next Destinies', 'Dark Explorers',
                'Dragons Exalted', 'Boundaries Crossed', 'Plasma Storm', 'Plasma Freeze', 'Plasma Blast',
                'Legendary Treasures'
            ].sort(),
            'Diamond & Pearl Series': [
                'Diamond & Pearl Base', 'Mysterious Treasures', 'Secret Wonders', 'Great Encounters', 'Majestic Dawn',
                'Legends Awakened', 'Stormfront', 'Platinum', 'Rising Rivals', 'Supreme Victors', 'Arceus', 'HeartGold & SoulSilver'
            ].sort(),
            'EX Series': [
                'EX Ruby & Sapphire', 'EX Sandstorm', 'EX Dragon', 'EX Team Magma vs Team Aqua', 'EX Hidden Legends',
                'EX FireRed & LeafGreen', 'EX Deoxys', 'EX Emerald', 'EX Unseen Forces', 'EX Delta Species',
                'EX Legend Maker', 'EX Holon Phantoms', 'EX Crystal Guardians', 'EX Dragon Frontiers', 'EX Power Keepers'
            ].sort(),
            'Base Set Era': [
                'Base Set', 'Jungle', 'Fossil', 'Base Set 2', 'Team Rocket', 'Gym Heroes', 'Gym Challenge',
                'Neo Genesis', 'Neo Discovery', 'Neo Revelation', 'Neo Destiny', 'Legendary Collection', 'Expedition Base Set',
                'Aquapolis', 'Skyridge'
            ].sort(),
            'Promotional Cards': [
                'Black Star Promos', 'POP Series', 'McDonald\'s Promos', 'Miscellaneous Promos'
            ].sort(),
            // Magic: The Gathering Expansions
            'Standard Sets': [
                'Bloomburrow', 'Duskmourn: House of Horror', 'Thunder Junction', 'Murders at Karlov Manor', 'The Lost Caverns of Ixalan',
                'Wilds of Eldraine', 'March of the Machine', 'Phyrexia: All Will Be One', 'Dominaria United', 'Streets of New Capenna',
                'Kamigawa: Neon Dynasty', 'Innistrad: Crimson Vow', 'Innistrad: Midnight Hunt', 'Forgotten Realms', 'Strixhaven: School of Mages',
                'Kaldheim', 'Zendikar Rising', 'Ikoria: Lair of Beasts', 'Theros Beyond Death', 'Eldraine', 'Core Set 2021', 'Core Set 2020'
            ].sort(),
            'Modern Sets': [
                'Modern Horizons 3', 'Modern Horizons 2', 'Modern Horizons'
            ].sort(),
            'Commander Products': [
                'Commander Legends: Battle for Baldur\'s Gate', 'Commander Masters', 'Commander (Various Years)'
            ].sort(),
            'Masters Sets': [
                'Double Masters 2022', 'Double Masters', 'Ultimate Masters', 'Modern Masters (Various Years)'
            ].sort(),
            'Supplemental Sets': [
                'Jumpstart 2022', 'Jumpstart', 'Secret Lair Drop Series (Various)'
            ].sort(),
            'Horizons Sets': [
                'Modern Horizons 3', 'Modern Horizons 2', 'Modern Horizons'
            ].sort(),
            'Universes Beyond': [
                'Fallout', 'Doctor Who', 'The Lord of the Rings: Tales of Middle-earth', 'Warhammer 40,000'
            ].sort(),
            // One Piece Card Game Expansions
            'Main Sets': [
                'OP-01 Romance Dawn', 'OP-02 Paramount War', 'OP-03 Pillars of Strength', 'OP-04 Kingdoms of Intrigue',
                'OP-05 Awakening of the New Era', 'OP-06 Wings of the Captain', 'OP-07 500 Years in the Future',
                'OP-08 Two Legends', 'OP-09 Four Emperors', 'OP-10 The New Age'
            ].sort(),
            'Starter Decks': [
                'ST-01 Straw Hat Crew', 'ST-02 Worst Generation', 'ST-03 The Seven Warlords of the Sea',
                'ST-04 Animal Kingdom Pirates', 'ST-05 Film Edition', 'ST-06 Absolute Justice',
                'ST-07 Big Mom Pirates', 'ST-08 Side Monkey', 'ST-09 Yamato'
            ].sort(),
            // Disney Lorcana Expansions
            'Chapter Sets': [
                'The First Chapter', 'Rise of the Floodborn', 'Into the Inklands', 'Ursula\'s Return', 'Shimmering Skies'
            ].sort(),
            'Gift Sets': [
                'Gift Set: Mickey & Minnie' // Example, add more if known
            ].sort(),
            // Accesorios Expansions (or sub-categories)
            'General': [
                'Standard Sleeves', 'Japanese Sleeves', 'Toploaders 3x4', 'Toploaders 5x7', '9-Pocket Binders',
                '12-Pocket Binders', 'Standard Playmats', 'Custom Playmats', 'Simple Deck Boxes',
                'Double Deck Boxes', 'Penny Sleeves', 'Storage Boxes', 'Dice', 'Counters',
                'Booster Protectors', 'Others'
            ].sort()
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Firebase services después de que el DOM esté completamente cargado
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); // Initialize Storage here
            const analytics = getAnalytics(app); 

            // Ahora que Firebase está inicializado, podemos configurar el listener de autenticación
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("User authenticated with ID:", userId);
                    setupFirestoreListeners(); // Empezar a escuchar Firestore después de la autenticación
                    fetchDolarBlue(); // Fetch Dolar Blue value after auth
                } else {
                    try {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    } catch (error) {
                        console.error("Error signing in:", error);
                        showFormMessage('Error de autenticación. Verifica tu configuración de Firebase y las reglas de seguridad.', 'error', formMessage);
                    }
                }
                populateNewStockFormFilters();
                addEventListeners();
                setTodayDateForSaleForm(); // Set default date
                loadTheme(); // Load theme on page load
            });
        });

        // --- FIRESTORE LISTENERS ---
        function setupFirestoreListeners() {
            if (!userId || !db || !storage) { // Ensure storage is also ready
                console.error("User ID, Firestore DB, or Storage is not available for Firestore listeners. Cannot set up listeners.");
                return;
            }
            
            // Listener for Inventory Data
            const inventoryCollectionPath = `artifacts/${appId}/public/data/sharedInventory`; 
            console.log("Setting up Firestore listener for inventory collection:", inventoryCollectionPath); 
            onSnapshot(collection(db, inventoryCollectionPath), async (snapshot) => { // Made async to await getImageDownloadURL
                inventoryData = [];
                for (const doc of snapshot.docs) {
                    const data = { id: doc.id, ...doc.data() };
                    // Attempt to get image URL from Storage if imagePath is present
                    if (data.imagePath) { // If a path to Firebase Storage is provided
                        try {
                            data.imageUrl = await getImageDownloadURL(data.imagePath);
                        } catch (error) {
                            console.warn(`Could not get image for path: ${data.imagePath}`, error);
                            data.imageUrl = 'https://placehold.co/50x50/FF6347/FFFFFF?text=Error'; // Placeholder for failed image
                        }
                    } else if (!data.imageUrl) {
                         data.imageUrl = 'https://placehold.co/50x50/CCCCCC/333333?text=No+Img'; // Generic placeholder if no path/url
                    }
                    inventoryData.push(data);
                }
                console.log("Firestore inventory listener updated. Total items:", inventoryData.length); 
                renderAll(); // Re-render everything when inventory data changes
                populateSaleFormItemSelect(); // Update sales form item dropdown
            }, (error) => {
                console.error("Error fetching inventory data:", error);
                showFormMessage(`Error al cargar el inventario: ${getFirebaseErrorMessage(error)}. Verifica tu conexión y las reglas de seguridad de Firestore.`, 'error', formMessage);
            });

            // Listener for Sales Data (New)
            const salesCollectionPath = `artifacts/${appId}/public/data/salesRecords`;
            console.log("Setting up Firestore listener for sales collection:", salesCollectionPath);
            onSnapshot(collection(db, salesCollectionPath), (snapshot) => {
                salesData = [];
                snapshot.forEach((doc) => {
                    salesData.push({ id: doc.id, ...doc.data() });
                });
                // Sort sales data by date, most recent first
                salesData.sort((a, b) => new Date(b.saleDate) - new Date(a.saleDate));
                console.log("Firestore sales listener updated. Total sales:", salesData.length);
                renderSalesSection(); // Re-render sales section when sales data changes
            }, (error) => {
                console.error("Error fetching sales data:", error);
                showFormMessage(`Error al cargar las ventas: ${getFirebaseErrorMessage(error)}.`, 'error', saleFormMessage);
            });
        }

        // --- Helper function for Storage Image URL ---
        async function getImageDownloadURL(imagePath) {
            if (!storage || !imagePath) return '';
            try {
                const imageRef = ref(storage, imagePath);
                return await getDownloadURL(imageRef);
            } catch (error) {
                console.error("Error getting download URL for image:", imagePath, error);
                throw error; // Re-throw to be caught by the caller
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            const filters = getFilters();
            let filteredData = applyFilters(filters);
            
            const shippingCommission = parseFloat(shippingCommissionInput.value) / 100 || 0; // Get shipping commission as a decimal

            // Calculate costoNeto and margenGanancia for all items in inventoryData
            inventoryData.forEach(item => {
                // Recalculate costoNeto based on current shipping commission
                item.costoNeto = item.costo * (1 + shippingCommission); 
                item.margenGanancia = item.venta - item.costoNeto;
            });

            // Apply sorting
            filteredData.sort((a, b) => {
                const aValue = a[currentSort.column] || '';
                const bValue = b[currentSort.column] || '';
                // Handle numeric sorting for specific columns
                if (['cantidad', 'costo', 'venta', 'ventaArs', 'margenGanancia'].includes(currentSort.column)) { 
                    return currentSort.order === 'asc' ? aValue - bValue : bValue - aValue;
                }
                // Default to string comparison for others
                return currentSort.order === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            });

            renderKPIs(filteredData);
            renderTable(filteredData);
            // renderCharts(filteredData); // Removed charts
            populateFilters(); // Asegurarse de que los filtros se poblen con los datos actualizados
        }

        function renderKPIs(data) {
            const totalStockValueCostNeto = data.reduce((sum, item) => sum + (item.cantidad * item.costoNeto), 0); // Use costoNeto
            const totalStockValueSale = data.reduce((sum, item) => sum + (item.cantidad * item.venta), 0);
            const potentialProfit = totalStockValueSale - totalStockValueCostNeto; // Use costoNeto
            const totalItems = data.reduce((sum, item) => sum + item.cantidad, 0);

            const kpis = [
                { title: 'Valor Total de Stock (Costo Neto)', value: `$${totalStockValueCostNeto.toFixed(2)}`, icon: '💰' },
                { title: 'Valor Total de Venta', value: `$${totalStockValueSale.toFixed(2)}`, icon: '📈' },
                { title: 'Ganancia Bruta Potencial', value: `$${potentialProfit.toFixed(2)}`, icon: '💸' },
                { title: 'Total de Artículos en Stock', value: totalItems.toLocaleString(), icon: '📦' }
            ];

            kpiSection.innerHTML = kpis.map(kpi => `
                <div class="kpi-card p-6 flex items-center">
                    <div class="text-4xl mr-4">${kpi.icon}</div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">${kpi.title}</p>
                        <p class="text-2xl font-bold text-gray-900">${kpi.value}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = '';
                noResultsDiv.classList.remove('hidden');
                return;
            }
            noResultsDiv.classList.add('hidden');

            const dolarBlueValue = parseFloat(dolarBlueInput.value) || 1; 

            tableBody.innerHTML = data.map(item => {
                // Determine stock level class
                let stockClass = '';
                if (item.cantidad === 0) {
                    stockClass = 'zero-stock';
                } else if (item.cantidad < 5) {
                    stockClass = 'low-stock';
                }

                const imageUrl = item.imageUrl || 'https://placehold.co/50x50/e2e8f0/4a5568?text=No+Img'; // Placeholder image

                return `
                <tr class="hover:bg-gray-50 ${stockClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <img src="${imageUrl}" alt="Imagen de ${item.articulo}" class="w-12 h-12 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/50x50/e2e8f0/4a5568?text=No+Img';">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.marca}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.coleccion}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.expansion}</td> 
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.articulo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.comentarios}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                        <div class="quantity-control">
                            <button class="quantity-button" onclick="updateQuantity('${item.id}', -1)">-</button>
                            <span class="quantity-display text-gray-900">${item.cantidad}</span>
                            <button class="quantity-button" onclick="updateQuantity('${item.id}', 1)">+</button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$${item.costo.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$${item.venta.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">ARS$${(item.venta * dolarBlueValue).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-700">$${item.margenGanancia.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showConfirmationModal('¿Estás seguro de que quieres eliminar este ítem?', () => deleteItem('${item.id}'))" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function renderSalesSection() {
            // Render Sales KPIs
            const totalSalesRevenue = salesData.reduce((sum, sale) => sum + (sale.quantitySold * sale.salePricePerUnit), 0);
            const totalProfitFromSales = salesData.reduce((sum, sale) => sum + sale.profitGenerated, 0);

            const salesKpis = [
                { title: 'Total de Ventas Realizadas', value: `$${totalSalesRevenue.toFixed(2)}`, icon: '💸' },
                { title: 'Ganancia Total por Ventas', value: `$${totalProfitFromSales.toFixed(2)}`, icon: '💰' }
            ];

            salesKpiSection.innerHTML = salesKpis.map(kpi => `
                <div class="kpi-card p-6 flex items-center">
                    <div class="text-4xl mr-4">${kpi.icon}</div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">${kpi.title}</p>
                        <p class="text-2xl font-bold text-gray-900">${kpi.value}</p>
                    </div>
                </div>
            `).join('');

            // Render Sales Table
            if (salesData.length === 0) {
                salesTableBody.innerHTML = '';
                noSalesResultsDiv.classList.remove('hidden');
                return;
            }
            noSalesResultsDiv.classList.add('hidden');

            salesTableBody.innerHTML = salesData.map(sale => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.saleDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${sale.itemName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${sale.quantitySold}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$${sale.salePricePerUnit.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$${(sale.quantitySold * sale.salePricePerUnit).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-700">$${sale.profitGenerated.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${sale.saleComments}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showConfirmationModal('¿Estás seguro de que quieres eliminar este registro de venta? El stock se repondrá.', () => deleteSale('${sale.id}'))" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- CHART RENDERING (Removed) ---
        // function renderCharts(data) {
        //     renderBrandChart(data);
        //     renderCollectionChart(data);
        // }
        
        // function renderBrandChart(data) { /* ... */ }
        // function renderCollectionChart(data) { /* ... */ }

        // --- FILTER & EVENT LOGIC ---
        function populateFilters() {
            // Store current selections before clearing options
            const currentBrand = brandFilter.value;
            const currentCollection = collectionFilter.value;
            const currentExpansion = expansionFilter.value;
            const currentItem = itemFilter.value;

            // Clear existing options for all filters
            brandFilter.innerHTML = '';
            collectionFilter.innerHTML = '';
            expansionFilter.innerHTML = '';
            itemFilter.innerHTML = '';

            // Add 'Todos' option first for all filters
            brandFilter.add(new Option('Todos', 'Todos'));
            collectionFilter.add(new Option('Todos', 'Todos'));
            expansionFilter.add(new Option('Todos', 'Todos'));
            itemFilter.add(new Option('Todos', 'Todos'));

            if (inventoryData.length === 0) {
                // If no data, ensure 'Todos' is selected and return
                brandFilter.value = 'Todos';
                collectionFilter.value = 'Todos';
                expansionFilter.value = 'Todos';
                itemFilter.value = 'Todos';
                return;
            }

            // Populate unique options from inventoryData
            const brands = [...new Set(inventoryData.map(item => item.marca))].sort();
            const collections = [...new Set(inventoryData.map(item => item.coleccion))].sort();
            const expansions = [...new Set(inventoryData.map(item => item.expansion))].sort();
            const articles = [...new Set(inventoryData.map(item => item.articulo))].sort();

            brands.forEach(b => brandFilter.add(new Option(b, b)));
            collections.forEach(c => collectionFilter.add(new Option(c, c)));
            expansions.forEach(e => expansionFilter.add(new Option(e, e)));
            articles.forEach(a => itemFilter.add(new Option(a, a)));

            // Attempt to re-select previous values, or default to 'Todos' if not found
            brandFilter.value = brands.includes(currentBrand) ? currentBrand : 'Todos';
            collectionFilter.value = collections.includes(currentCollection) ? currentCollection : 'Todos';
            expansionFilter.value = expansions.includes(currentExpansion) ? currentExpansion : 'Todos';
            itemFilter.value = articles.includes(currentItem) ? currentItem : 'Todos';
        }

        function getFilters() {
            return {
                brand: brandFilter.value,
                collection: collectionFilter.value,
                expansion: expansionFilter.value, // Get expansion filter value
                item: itemFilter.value, 
                search: searchInput.value.toLowerCase()
            };
        }

        function applyFilters(filters) {
            return inventoryData.filter(d => 
                (filters.brand === 'Todos' || d.marca === filters.brand) &&
                (filters.collection === 'Todos' || d.coleccion === filters.collection) &&
                (filters.expansion === 'Todos' || d.expansion === filters.expansion) && // Apply expansion filter
                (filters.item === 'Todos' || d.articulo === filters.item) && 
                (d.comentarios.toLowerCase().includes(filters.search))
            );
        }
        
        function addEventListeners() {
            brandFilter.addEventListener('change', renderAll);
            collectionFilter.addEventListener('change', renderAll);
            expansionFilter.addEventListener('change', renderAll); 
            itemFilter.addEventListener('change', renderAll);
            searchInput.addEventListener('input', renderAll);
            addStockForm.addEventListener('submit', handleAddStock);
            addSaleForm.addEventListener('submit', handleAddSale); // New: Sales form submission
            // Dolar blue and shipping commission inputs now trigger renderAll directly via oninput attribute in HTML
            exportCsvButton.addEventListener('click', exportToCSV); // Event listener for export button
            
            // Event listeners for dynamic options in new stock form
            newMarcaSelect.addEventListener('change', () => {
                updateNewCollectionAndExpansionOptions();
                updateNewArticleOptions();
            });
            newColeccionSelect.addEventListener('change', updateNewExpansionOptions);
            newCostoInput.addEventListener('input', updateCalculatedFields); 
            newVentaInput.addEventListener('input', updateCalculatedFields); 

            // New: Event listener for sales item select to auto-fill price
            saleItemSelect.addEventListener('change', autoFillSalePrice);

            // Event listeners para ordenación de tabla
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.order = 'asc';
                    }
                    renderAll();
                });
            });

            // Event listeners for confirmation modal
            confirmButton.addEventListener('click', () => {
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
                hideConfirmationModal();
            });
            cancelButton.addEventListener('click', hideConfirmationModal);

            // Dark mode toggle event listener
            themeToggle.addEventListener('click', toggleTheme);
        }

        // --- NEW STOCK FORM LOGIC ---
        function populateNewStockFormFilters() {
            const brands = Object.keys(articleMappings).sort();
            const estados = ['Disponible', 'Pocas Unidades', 'Agotado', 'Próximamente'];
            const idiomas = ['Inglés', 'Español', 'Japonés', 'N/A'];

            newMarcaSelect.innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join('');
            newEstadoSelect.innerHTML = estados.map(e => `<option value="${e}">${e}</option>`).join('');
            newIdiomaSelect.innerHTML = idiomas.map(i => `<option value="${i}">${i}</option>`).join('');
            
            // Populate article and collection/expansion options based on the initially selected brand
            updateNewCollectionAndExpansionOptions(); // Initial population for collections and expansions
            updateNewArticleOptions(); // Initial population for articles
            updateCalculatedFields(); 
        }

        function updateNewArticleOptions() {
            const selectedBrand = newMarcaSelect.value;
            // Filter articles based on selected brand
            const articlesForBrand = articleMappings[selectedBrand] || [];
            newArticuloSelect.innerHTML = articlesForBrand.map(a => `<option value="${a}">${a}</option>`).join('');
            // Reset article selection to the first available option or empty
            newArticuloSelect.value = articlesForBrand[0] || '';
        }

        function updateNewCollectionAndExpansionOptions() {
            const selectedBrand = newMarcaSelect.value;
            // Filter collections based on selected brand
            const collectionsForBrand = collectionMappings[selectedBrand] || [];
            newColeccionSelect.innerHTML = collectionsForBrand.map(c => `<option value="${c}">${c}</option>`).join('');
            // Reset collection selection to the first available option or empty
            newColeccionSelect.value = collectionsForBrand[0] || '';
            
            // Also update expansions when brand or collection changes
            updateNewExpansionOptions();
        }

        function updateNewExpansionOptions() {
            const selectedCollection = newColeccionSelect.value;
            // Filter expansions based on selected collection
            const expansionsForCollection = expansionMappings[selectedCollection] || [];
            expansionsDatalist.innerHTML = expansionsForCollection.map(e => `<option value="${e}">`).join('');
            // Clear the input field when the collection changes to avoid stale data
            newExpansionInput.value = '';
        }


        function updateCalculatedFields() {
            const costoUnitario = parseFloat(newCostoInput.value);
            const precioVenta = parseFloat(newVentaInput.value);
            const dolarBlueValue = parseFloat(dolarBlueInput.value) || 1;
            const shippingCommission = parseFloat(shippingCommissionInput.value) / 100 || 0;

            // Calculate Precio Venta (ARS)
            if (!isNaN(precioVenta)) {
                newVentaArsInput.value = (precioVenta * dolarBlueValue).toFixed(2);
            } else {
                newVentaArsInput.value = '';
            }

            // Calculate Margen de Ganancia (now based on costoUnitario and shipping commission)
            if (!isNaN(precioVenta) && !isNaN(costoUnitario)) {
                const calculatedCostoNeto = costoUnitario * (1 + shippingCommission);
                newMargenGananciaInput.value = (precioVenta - calculatedCostoNeto).toFixed(2);
            } else {
                newMargenGananciaInput.value = '';
            }
        }

        // --- Form Validation ---
        function validateForm(formId) {
            let isValid = true;
            let errorElements;
            let inputs;

            // Helper to hide all error messages for a given form's error elements
            const hideAllErrors = (elements) => {
                elements.forEach(el => {
                    // Check if el is not null before trying to access classList
                    if (el) {
                        el.classList.add('hidden');
                    }
                });
            };

            if (formId === 'add-stock-form') {
                errorElements = [errorNewMarca, errorNewColeccion, errorNewExpansion, errorNewArticulo, errorNewIdioma, errorNewCantidad, errorNewCosto, errorNewVenta, errorNewEstado];
                hideAllErrors(errorElements); // Hide errors before re-validating
                inputs = [
                    { el: newMarcaSelect, msg: errorNewMarca, check: () => !!newMarcaSelect.value },
                    { el: newColeccionSelect, msg: errorNewColeccion, check: () => !!newColeccionSelect.value },
                    { el: newExpansionInput, msg: errorNewExpansion, check: () => !!newExpansionInput.value },
                    { el: newArticuloSelect, msg: errorNewArticulo, check: () => !!newArticuloSelect.value },
                    { el: newIdiomaSelect, msg: errorNewIdioma, check: () => !!newIdiomaSelect.value },
                    { el: newCantidadInput, msg: errorNewCantidad, check: () => !isNaN(parseInt(newCantidadInput.value)) && parseInt(newCantidadInput.value) >= 0 },
                    { el: newCostoInput, msg: errorNewCosto, check: () => !isNaN(parseFloat(newCostoInput.value)) && parseFloat(newCostoInput.value) >= 0 },
                    { el: newVentaInput, msg: errorNewVenta, check: () => !isNaN(parseFloat(newVentaInput.value)) && parseFloat(newVentaInput.value) >= 0 },
                    { el: newEstadoSelect, msg: errorNewEstado, check: () => !!newEstadoSelect.value }
                ];
            } else if (formId === 'add-sale-form') {
                errorElements = [errorSaleItemSelect, errorSaleQuantityInput, errorSalePricePerUnitInput, errorSaleDateInput];
                hideAllErrors(errorElements); // Hide errors before re-validating
                inputs = [
                    { el: saleItemSelect, msg: errorSaleItemSelect, check: () => !!saleItemSelect.value },
                    { el: saleQuantityInput, msg: errorSaleQuantityInput, check: () => !isNaN(parseInt(saleQuantityInput.value)) && parseInt(saleQuantityInput.value) > 0 },
                    { el: salePricePerUnitInput, msg: errorSalePricePerUnitInput, check: () => !isNaN(parseFloat(salePricePerUnitInput.value)) && parseFloat(salePricePerUnitInput.value) >= 0 },
                    { el: saleDateInput, msg: errorSaleDateInput, check: () => !!saleDateInput.value }
                ];
            } else {
                return false; // Unknown form
            }

            // Check each input
            inputs.forEach(input => {
                if (!input.check()) {
                    // Ensure input.msg is not null before trying to remove class
                    if (input.msg) {
                        input.msg.classList.remove('hidden');
                    }
                    isValid = false;
                }
            });

            return isValid;
        }


        async function handleAddStock(event) {
            event.preventDefault(); 
            showLoading(true); // Show loading spinner

            if (!isAuthReady || !userId || !db || !storage) { // Check for storage availability
                showFormMessage('Autenticación, base de datos o almacenamiento no listos. Por favor, espere o recargue la página. Asegúrate de que Firebase esté configurado.', 'error', formMessage);
                showLoading(false);
                return;
            }

            if (!validateForm('add-stock-form')) {
                showFormMessage('Por favor, complete todos los campos obligatorios y asegúrese de que los valores numéricos sean válidos.', 'error', formMessage);
                showLoading(false);
                return;
            }

            const costoUnitario = parseFloat(newCostoInput.value);
            const shippingCommission = parseFloat(shippingCommissionInput.value) / 100 || 0;
            const calculatedCostoNeto = costoUnitario * (1 + shippingCommission); // Calculate costoNeto here before saving

            let imageUrl = ''; // Initialize imageUrl
            const imageFile = newImageFileInput.files[0];

            if (imageFile) {
                try {
                    // Create a unique filename for the image
                    const fileName = `${Date.now()}-${imageFile.name}`;
                    const storageRef = ref(storage, `productos/${fileName}`); // Upload to 'productos' folder
                    
                    // Upload the file
                    const uploadResult = await uploadBytes(storageRef, imageFile);
                    
                    // Get the download URL
                    imageUrl = await getDownloadURL(uploadResult.ref); 
                    console.log('Imagen subida a Storage:', imageUrl);

                } catch (error) {
                    console.error("Error al subir la imagen a Firebase Storage:", error);
                    showFormMessage('Error al subir la imagen. Intente de nuevo.', 'error', formMessage);
                    showLoading(false); // Hide loading spinner
                    return;
                }
            }

            const newEntry = {
                marca: newMarcaSelect.value,
                coleccion: newColeccionSelect.value, 
                expansion: newExpansionInput.value,
                articulo: newArticuloSelect.value,
                comentarios: newComentariosInput.value, 
                idioma: newIdiomaSelect.value,
                cantidad: parseInt(newCantidadInput.value),
                costo: costoUnitario,
                costoNeto: calculatedCostoNeto, // Store calculated costoNeto
                venta: parseFloat(newVentaInput.value),
                margenGanancia: parseFloat(newMargenGananciaInput.value), 
                estado: newEstadoSelect.value,
                imageUrl: imageUrl // Save the image URL obtained from Storage
            };

            try {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/sharedInventory`); 
                const docRef = await addDoc(collectionRef, newEntry); 
                console.log("Document added with ID: ", docRef.id); 
                showFormMessage(`Stock agregado exitosamente.`, 'success', formMessage);
            }
            catch (error) {
                console.error("Error adding document: ", error);
                showFormMessage(`Error al agregar el stock: ${getFirebaseErrorMessage(error)}. Intente de nuevo.`, 'error', formMessage);
            } finally {
                showLoading(false); // Hide loading spinner
                addStockForm.reset();
                populateNewStockFormFilters(); 
                // The message will auto-hide via showFormMessage
            }
        }

        // --- NEW SALES FORM LOGIC ---
        function populateSaleFormItemSelect() {
            saleItemSelect.innerHTML = '<option value="">Selecciona un artículo</option>'; // Clear and add default
            // Sort inventory data by item name for easier selection
            const sortedInventory = [...inventoryData].sort((a, b) => {
                // Prioritize items with stock > 0
                if (a.cantidad > 0 && b.cantidad === 0) return -1;
                if (a.cantidad === 0 && b.cantidad > 0) return 1;
                return a.articulo.localeCompare(b.articulo);
            });

            sortedInventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.articulo} (${item.marca} - ${item.coleccion} - ${item.expansion}) - Stock: ${item.cantidad}`;
                // Disable option if stock is 0
                if (item.cantidad === 0) {
                    option.disabled = true;
                    option.textContent += ' (Agotado)';
                }
                saleItemSelect.appendChild(option);
            });
        }

        function autoFillSalePrice() {
            const selectedItemId = saleItemSelect.value;
            const selectedItem = inventoryData.find(item => item.id === selectedItemId);
            if (selectedItem) {
                salePricePerUnitInput.value = selectedItem.venta.toFixed(2);
                saleQuantityInput.max = selectedItem.cantidad; // Set max quantity to available stock
                saleQuantityInput.value = Math.min(1, selectedItem.cantidad); // Default to 1 or 0 if no stock
            } else {
                salePricePerUnitInput.value = '';
                saleQuantityInput.max = ''; // Clear max if no item selected
                saleQuantityInput.value = '';
            }
        }

        function setTodayDateForSaleForm() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            saleDateInput.value = `${yyyy}-${mm}-${dd}`;
        }

        async function handleAddSale(event) {
            event.preventDefault();
            showLoading(true); // Show loading spinner

            if (!isAuthReady || !userId || !db) {
                showFormMessage('Autenticación o base de datos no listas. Por favor, espere o recargue la página.', 'error', saleFormMessage);
                showLoading(false);
                return;
            }

            if (!validateForm('add-sale-form')) {
                showFormMessage('Por favor, complete todos los campos obligatorios y asegúrese de que los valores numéricos sean válidos.', 'error', saleFormMessage);
                showLoading(false);
                return;
            }

            const selectedItemId = saleItemSelect.value;
            const itemSold = inventoryData.find(item => item.id === selectedItemId);

            if (!itemSold) {
                showFormMessage('Artículo seleccionado no encontrado en el inventario.', 'error', saleFormMessage);
                showLoading(false);
                return;
            }

            const quantitySold = parseInt(saleQuantityInput.value);

            if (quantitySold > itemSold.cantidad) {
                showFormMessage(`No hay suficiente stock. Cantidad disponible: ${itemSold.cantidad}.`, 'error', saleFormMessage);
                showLoading(false);
                return;
            }

            const salePricePerUnit = parseFloat(salePricePerUnitInput.value);
            const profitGenerated = (salePricePerUnit - itemSold.costoNeto) * quantitySold;

            const newSale = {
                itemId: selectedItemId,
                itemName: `${itemSold.articulo} (${itemSold.marca} - ${itemSold.coleccion})`, // Store a descriptive name
                quantitySold: quantitySold,
                salePricePerUnit: salePricePerUnit,
                saleDate: saleDateInput.value,
                saleComments: saleCommentsInput.value,
                profitGenerated: profitGenerated, // Store calculated profit
                timestamp: new Date().toISOString() // For accurate sorting/tracking
            };

            try {
                // 1. Add sale record
                const salesCollectionRef = collection(db, `artifacts/${appId}/public/data/salesRecords`);
                await addDoc(salesCollectionRef, newSale);
                console.log("Sale recorded successfully.");

                // 2. Update inventory item quantity
                const newQuantityInStock = itemSold.cantidad - quantitySold;
                const itemRef = doc(db, `artifacts/${appId}/public/data/sharedInventory`, selectedItemId);
                await updateDoc(itemRef, { cantidad: newQuantityInStock });
                console.log(`Inventory quantity for ${itemSold.articulo} updated to ${newQuantityInStock}`);

                showFormMessage('Venta registrada y stock actualizado exitosamente.', 'success', saleFormMessage);
            } catch (error) {
                console.error("Error recording sale or updating inventory:", error);
                showFormMessage(`Error al registrar la venta: ${getFirebaseErrorMessage(error)}.`, 'error', saleFormMessage);
            } finally {
                showLoading(false); // Hide loading spinner
            }

            addSaleForm.reset();
            setTodayDateForSaleForm(); // Reset date to today
            populateSaleFormItemSelect(); // Re-populate to show updated stock counts
            saleQuantityInput.max = ''; // Clear max attribute
            salePricePerUnitInput.value = ''; // Clear auto-filled price
            // The message will auto-hide via showFormMessage
        }


        // --- UPDATE QUANTITY FUNCTION (for inventory table +/- buttons) ---
        async function updateQuantity(itemId, changeAmount) {
            showLoading(true); // Show loading spinner
            if (!isAuthReady || !userId || !db) {
                console.error("User ID or Firestore DB is not available for quantity update.");
                showLoading(false);
                return;
            }

            const itemToUpdate = inventoryData.find(item => item.id === itemId);
            if (!itemToUpdate) {
                console.error("Item not found for update:", itemId);
                showLoading(false);
                return;
            }

            const newQuantity = Math.max(0, itemToUpdate.cantidad + changeAmount); // Ensure quantity doesn't go below 0

            try {
                const itemRef = doc(db, `artifacts/${appId}/public/data/sharedInventory`, itemId); 
                await updateDoc(itemRef, { cantidad: newQuantity });
                console.log(`Quantity for item ${itemId} updated to ${newQuantity}`);
            } catch (error) {
                console.error("Error updating quantity:", error);
                showFormMessage(`Error al actualizar la cantidad: ${getFirebaseErrorMessage(error)}.`, 'error', formMessage);
            } finally {
                showLoading(false); // Hide loading spinner
            }
        }

        // --- DELETE ITEM FUNCTION (for inventory table) ---
        async function deleteItem(idToDelete) {
            showLoading(true); // Show loading spinner
            if (!isAuthReady || !userId || !db) {
                console.error("User ID or Firestore DB is not available for deletion.");
                showLoading(false);
                return;
            }
            console.log(`Attempting to delete item with ID: ${idToDelete} from collection: artifacts/${appId}/public/data/sharedInventory`); // Log the ID being deleted
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/sharedInventory`, idToDelete)); 
                console.log("Document successfully deleted!");
                showFormMessage('Ítem eliminado exitosamente.', 'success', formMessage);
            } catch (error) {
                console.error("Error removing document: ", error);
                showFormMessage(`Error al eliminar el ítem: ${getFirebaseErrorMessage(error)}.`, 'error', formMessage);
            } finally {
                showLoading(false); // Hide loading spinner
            }
        }

        // --- DELETE SALE FUNCTION (New) ---
        async function deleteSale(saleIdToDelete) {
            showLoading(true); // Show loading spinner
            if (!isAuthReady || !userId || !db) {
                console.error("User ID or Firestore DB is not available for sale deletion.");
                showLoading(false);
                return;
            }

            const saleRef = doc(db, `artifacts/${appId}/public/data/salesRecords`, saleIdToDelete);

            try {
                // 1. Get sale details to revert stock
                const saleDoc = await getDoc(saleRef);
                if (!saleDoc.exists()) {
                    showFormMessage('Registro de venta no encontrado.', 'error', saleFormMessage);
                    showLoading(false);
                    return;
                }
                const saleData = saleDoc.data();
                const itemIdToRevert = saleData.itemId;
                const quantityToRevert = saleData.quantitySold;

                // 2. Delete the sale record
                await deleteDoc(saleRef);
                console.log("Sale record successfully deleted!");

                // 3. Update inventory item: add quantity back
                const itemToUpdate = inventoryData.find(item => item.id === itemIdToRevert);
                if (itemToUpdate) {
                    const newItemQuantity = itemToUpdate.cantidad + quantityToRevert;
                    const itemInventoryRef = doc(db, `artifacts/${appId}/public/data/sharedInventory`, itemIdToRevert);
                    await updateDoc(itemInventoryRef, { cantidad: newItemQuantity });
                    console.log(`Stock for item ${itemToUpdate.articulo} reverted by ${quantityToRevert}. New quantity: ${newItemQuantity}`);
                } else {
                    console.warn(`Item with ID ${itemIdToRevert} not found in inventory to revert stock.`);
                    showFormMessage(`Venta eliminada, pero el artículo original ya no está en el inventario.`, 'warning', saleFormMessage);
                }

                showFormMessage('Venta eliminada y stock revertido exitosamente.', 'success', saleFormMessage);
            } catch (error) {
                console.error("Error deleting sale or reverting stock: ", error);
                showFormMessage(`Error al eliminar la venta: ${getFirebaseErrorMessage(error)}.`, 'error', saleFormMessage);
            } finally {
                showLoading(false); // Hide loading spinner
            }
        }

        // --- DOLAR BLUE API INTEGRATION ---
        async function fetchDolarBlue() {
            try {
                // Using DolarAPI.com for Dólar Blue
                const response = await fetch('https://dolarapi.com/api/v1/dolares/blue');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // DolarAPI.com for /api/v1/dolares/blue directly returns the blue object
                const dolarBlue = data; 
                
                if (dolarBlue && dolarBlue.venta) {
                    dolarBlueInput.value = dolarBlue.venta.toFixed(2);
                    console.log("Dólar Blue fetched:", dolarBlue.venta);
                } else {
                    console.warn("Could not find 'venta' value for Dólar Blue in API response.");
                    showFormMessage('No se pudo obtener la cotización del Dólar Blue de la API. Usando valor manual.', 'warning', formMessage);
                }
            } catch (error) {
                console.error("Error fetching Dólar Blue from API:", error);
                showFormMessage('Error al obtener la cotización del Dólar Blue. Usando valor manual.', 'error', formMessage);
            } finally {
                renderAll(); // Re-render to update calculations with fetched or default dolar blue
            }
        }


        // --- UTILITY FUNCTIONS ---

        // Function to show custom confirmation modal
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            onConfirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        // Function to hide custom confirmation modal
        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            onConfirmCallback = null;
        }

        // Function to show/hide loading spinner
        function showLoading(isLoading) {
            if (isLoading) {
                loadingOverlay.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Function to show form messages (success/error)
        function showFormMessage(message, type, targetElement) {
            targetElement.textContent = message;
            targetElement.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-orange-600'); // Added orange for warning
            if (type === 'success') {
                targetElement.classList.add('text-green-600');
            } else if (type === 'error') {
                targetElement.classList.add('text-red-600');
            } else if (type === 'warning') { // New warning type
                targetElement.classList.add('text-orange-600');
            }
            // Auto-hide after 5 seconds
            setTimeout(() => {
                targetElement.classList.add('hidden');
            }, 5000);
        }

        // Function to get user-friendly Firebase error messages
        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'permission-denied':
                    return 'Permiso denegado. Verifica las reglas de seguridad de Firestore.';
                case 'unavailable':
                    return 'Servicio no disponible. Verifica tu conexión a internet.';
                case 'resource-exhausted':
                    return 'Cuota de Firebase excedida. Intenta más tarde.';
                case 'not-found':
                    return 'Documento no encontrado.';
                default:
                    return error.message || 'Error desconocido.';
            }
        }

        // --- THEME TOGGLE FUNCTIONS ---
        function toggleTheme() {
            if (document.body.classList.contains('dark')) {
                document.body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            // Re-render to apply theme-specific classes to dynamically generated content
            renderAll();
            renderSalesSection();
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
            } else if (savedTheme === 'light') {
                document.body.classList.remove('dark');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // If no preference, check system preference
                document.body.classList.add('dark');
            }
            // Re-render to ensure all elements reflect the loaded theme
            renderAll();
            renderSalesSection();
        }

        // --- EXPORT TO CSV FUNCTION ---
        function exportToCSV() {
            if (inventoryData.length === 0) {
                showFormMessage('No hay datos en el inventario para exportar.', 'error', formMessage);
                return;
            }

            // Manually define the order of headers for CSV to match the table display order
            const csvHeaders = [
                'Marca', 'Colección', 'Expansión', 'Artículo', 'Comentarios', 'Cantidad', 
                'Costo (USD)', 'Costo Neto (USD)', 'Venta (USD)', 'Venta (ARS)', 'Margen de Ganancia (USD)', 'Idioma', 'Estado', 'URL Imagen'
            ];

            // Map filteredData to CSV rows
            const rows = inventoryData.map(item => {
                // Ensure values are strings and handle commas if they exist in data
                return [
                    `"${item.marca ? item.marca.replace(/"/g, '""') : ''}"`,
                    `"${item.coleccion ? item.coleccion.replace(/"/g, '""') : ''}"`,
                    `"${item.expansion ? item.expansion.replace(/"/g, '""') : ''}"`,
                    `"${item.articulo ? item.articulo.replace(/"/g, '""') : ''}"`,
                    `"${item.comentarios ? item.comentarios.replace(/"/g, '""') : ''}"`,
                    item.cantidad !== undefined ? item.cantidad : '',
                    item.costo !== undefined ? item.costo.toFixed(2) : '',
                    item.costoNeto !== undefined ? item.costoNeto.toFixed(2) : '', // Include costoNeto in export
                    item.venta !== undefined ? item.venta.toFixed(2) : '',
                    item.venta !== undefined ? (item.venta * (parseFloat(dolarBlueInput.value) || 1)).toFixed(2) : '',
                    item.margenGanancia !== undefined ? item.margenGanancia.toFixed(2) : '',
                    `"${item.idioma ? item.idioma.replace(/"/g, '""') : ''}"`,
                    `"${item.estado ? item.estado.replace(/"/g, '""') : ''}"`,
                    `"${item.imageUrl ? item.imageUrl.replace(/"/g, '""') : ''}"`
                ].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8," 
                               + csvHeaders.join(',') + '\n' 
                               + rows.join('\n');

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "inventario_tcg.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link); // Clean up
            showFormMessage('Datos exportados a inventario_tcg.csv', 'success', formMessage);
        }

        // Expose functions to global scope for onclick (for table buttons)
        window.updateQuantity = updateQuantity;
        window.showConfirmationModal = showConfirmationModal; // Expose modal function
        window.deleteSale = deleteSale; // Expose new deleteSale function
        window.deleteItem = deleteItem; // Ensure deleteItem is also exposed
        window.renderAll = renderAll; // Expose renderAll for oninput in HTML
    </script>
</body>
</html>
